package com.malware.surround;

import androidx.annotation.NonNull;
import androidx.appcompat.app.AppCompatActivity;
import androidx.core.app.ActivityCompat;
import androidx.core.content.ContextCompat;
import android.Manifest;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.net.Uri;
import android.os.Bundle;
import android.provider.Settings;
import android.util.Log;
import android.view.View;
import android.widget.Button;

import com.google.android.material.dialog.MaterialAlertDialogBuilder;
import com.malware.surround.screens.SongListActivity;

import java.util.ArrayList;

public class MainActivity extends AppCompatActivity implements ActivityCompat.OnRequestPermissionsResultCallback, View.OnClickListener {
    Button nextButton;
    Button grantPermissionButton;
    public static String TAG = MainActivity.class.getSimpleName();
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        if(hasPermissions()){
            moveToMainScreen();
        }
        else {
            setContentView(R.layout.permission_page);
            grantPermissionButton = findViewById(R.id.grant_permissions);
            nextButton = findViewById(R.id.permissions_next);
            // Adding Listeners
            grantPermissionButton.setOnClickListener(this);
            nextButton.setOnClickListener(this);
        }
    }

    @Override
    protected void onRestart() {
        super.onRestart();
        if(!hasPermissions()){
            nextButton.setAlpha(0.2f);
            nextButton.setEnabled(false);
        }
        else {
            moveToMainScreen();
        }
        Log.e(TAG, String.valueOf(hasPermissions()));
    }

    private void moveToMainScreen(){
        Intent intent = new Intent(this, SongListActivity.class);
        startActivity(intent);
        finish();
    }
    // Checking for Permission status
    private boolean hasPermissions(){
        if(ContextCompat.checkSelfPermission(this, Manifest.permission.WRITE_EXTERNAL_STORAGE) == PackageManager.PERMISSION_GRANTED){
            return true;
        }
        return false;
    }
    // Permission Handling
    private void getPermissions(){
        if(hasPermissions()){
            grantPermissionButton.setEnabled(false);
            nextButton.setVisibility(View.VISIBLE);
            moveToMainScreen();
        }
        else{
            // In api 23 and above we have deny and don't ask again option, so we wouldn't be able to request permissions programatically
            // So to handle that we are using thus shouldShowRequestPermissionRationale method
            if(shouldShowRequestPermissionRationale(Manifest.permission.WRITE_EXTERNAL_STORAGE)){
                showPermissionRequestDialogue();
            }
            else{
                // Requesting permission in old way
                ActivityCompat.requestPermissions(
                        MainActivity.this, new String[]{Manifest.permission.WRITE_EXTERNAL_STORAGE}, 0);
            }
        }
    }

    private void showPermissionRequestDialogue(){
        // To open app setting and to get permission manually
        // Uri params fromParts( schema, chartSequence, fragment )
        // We can also use Uri.parse("package:" + getPackageName()); but dis looks bad
        Intent intent = new Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS);
        Uri uri = Uri.fromParts("package", getPackageName(), null);
        intent.setData(uri);
        // Simple alert dialog
        new MaterialAlertDialogBuilder(this)
                .setTitle("PERMISSIONS NEEDED")
                .setMessage("Please provide proper permissions before accessing media files")
                .setPositiveButton("Go to settings", (dialogInterface, i) -> {
                    startActivity(intent);
                    nextButton.setVisibility(View.VISIBLE);
                })
                .setNegativeButton(
                        "Exit", (dialogInterface, i) -> System.exit(0)
                ).show();
    }
    
    // Handling Runtime permission request
    // If granted moves to mainScreen else opens a alertDialog
    @Override
    public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults);
        if (grantResults[0] == PackageManager.PERMISSION_GRANTED) {
            grantPermissionButton.setEnabled(false);
            nextButton.setVisibility(View.VISIBLE);
            moveToMainScreen();
        }
        else{
            showPermissionRequestDialogue();
        }
    }
    // ClickListeners
    @Override
    public void onClick(View view) {
        if(view.getId() == R.id.grant_permissions){
            getPermissions();
        }
        else if(view.getId() == R.id.permissions_next){
            moveToMainScreen();
        }
    }
}